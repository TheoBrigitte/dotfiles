#!/usr/bin/env bash

set -eu

print_usage() {
  echo "Usage:
  $(basename $0) <installation> [ <separator> <cluster> ]

Create kubeconfig for the given cluster or installation.

  <installation>	installation name
  <separator>		can be any non alphanum character
  <cluster>		cluster name"
}


if [ $# -lt 1 ] || [ "$1" == "-h" ]; then
  print_usage
  exit 0
fi

# Arguments

# replace / separator with space.
args=$(echo -n "$@" | sed -e 's/[^[:alnum:]]/ /g')

# bash will split words on spaces.
values=($args)

INSTALLATION="${values[0]}"
CLUSTER=""
CONTEXT_MATCHER="${INSTALLATION}"

values_length=${#values[@]}
if [ $values_length -ge 2 ]; then
  CLUSTER="${values[$values_length-1]}"
  CONTEXT_MATCHER="${INSTALLATION}-${CLUSTER}"
fi


CONTEXT_NAME=$(kubectl config get-contexts -oname | grep "${CONTEXT_MATCHER}" | head -zn1)
if [ -n "${CONTEXT_NAME}" ]; then
	timeout 3s kubectl --context "${CONTEXT_NAME}" get nodes &>/dev/null && \
		kubectx "${CONTEXT_NAME}" && \
		exit 0
fi

PROVIDER=$(opsctl show installation -i "${INSTALLATION}" | yq -r .Provider)
if [ "${PROVIDER}" == "openstack" ]; then
(
	set -e
	if [ -n "${CLUSTER}" ]; then
		echo "/!\ cluster kubeconfig not supported on openstack installations"
	fi
	lpass show --notes "Shared-Team Rocket/CAPO\kubeconfigs/${INSTALLATION}.kubeconfig" > /tmp/${INSTALLATION}.kubeconfig
	CONTEXT_NAME=$(kubectl --kubeconfig /tmp/${INSTALLATION}.kubeconfig config current-context)
	KUBECONFIG=~/.kube/config:/tmp/${INSTALLATION}.kubeconfig kubectl config view --merge --flatten > /tmp/kube.config
	mv --backup --suffix=.gx /tmp/kube.config ~/.kube/config
	kubectx "${CONTEXT_NAME}"
	#kubectl gs login https://api.hubble.thg.gigantic.io --cluster-admin $CLUSTER
)
else
(
	set -ex
	opsctl login "${INSTALLATION}" "${CLUSTER}"
)
fi
