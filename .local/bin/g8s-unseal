#!/bin/bash

set -eu

if [ $# -lt 1 ] || [ "$1" == "-h" ]; then
	echo "Usage: $(basename $0) <installation>
Unseal vault node on the given <installation>"
	exit 1
fi

INSTALLATION=$1
GPG_USER=${2:-theo01}
SSH_USER=${3:-theo}

INSTALLATION=${GOPATH}/src/github.com/giantswarm/installations
OPSCTL=$(command -v opsctl)
BASE64=$(command -v base64)
GPG=$(command -v gpg)
DECRYPT="${GPG} -qd"

if [ -z ${INSTALLATION} ]; then
	echo "missing installation"
	exit 1
fi

# Decrypt unseal-key from installation repo
# base64 -d installations/<codname>/vault/unseal-keys/<user> | gpg -qd
echo "> decrypt ${GPG_USER} unseal-key for ${INSTALLATION}"
UNSEAL_KEY=$(${BASE64} -d ${INSTALLATION}/${INSTALLATION}/vault/unseal-keys/${GPG_USER} | ${DECRYPT})

# Unseal vault
# opsctl ssh --cert-based=false --machine-user=theo <installation> vault1
# vault operator unseal <unseal key>
echo "> unseal ${INSTALLATION} using ${SSH_USER} user"
opsctl ssh --cert-based=false --machine-user=${SSH_USER} ${INSTALLATION} vault1 --cmd "bash -lc 'vault operator unseal "${UNSEAL_KEY}"'"

