#!/usr/bin/env bash

get_installation() {
	interactive=${1:-false}

	if $interactive; then
		name=$(opsctl list installations -s | tr ' ' '\n'|fzf --tac)
		gx "$name" &>/dev/null
	fi

	installation=$(kubectl config current-context | cut -d- -f2-)

	echo "$installation"
	return
}

get_release() {
	interactive=${1:-false}

	releases=$(kubectl get release --sort-by .spec.date -oyaml)
	len=$(echo "$releases" | yq -r '.items | length')
	release_candidates=()
	for (( i=$len-1; i>=0; i-- )); do
		name=$(echo "$releases" | yq -r ".items[$i].metadata.name")
		state=$(echo "$releases" | yq -r ".items[$i].spec.state")
		ready=$(echo "$releases" | yq -r ".items[$i].status.ready")
		#echo -e "> name  : $name\n  active: $state\n  ready : $ready"
		if echo "$name" | grep -vq "-" && [[ "$ready" == "true" ]]; then
			if $interactive; then
				release_candidates+=("$name")
			else
				echo "$name"
				return
			fi
		fi
	done

	if $interactive && [[ ${#release_candidates[@]} -gt 0 ]]; then
		name=$(printf '%s\n' "${release_candidates[@]}" | fzf)
		echo "$name"
	fi

	return
}

if [[ "$1" == "-h" ]] || [[ $# -lt 1 ]]; then
	echo "Usage: gcluster [options] <action> <name>

Manage giantswarm CAPI clusters.

Options
        -i        interactive mode (select release)

Arguments

        <action> : any valid kubectl verb (e.g. apply)
	<name>   : cluster name"
        exit 1
fi

interactive=false
until=$(date --utc +"%Y-%m-%d")

ARGS=$(getopt -o 'iu:' --long 'interactive,until:' -- "$@")
eval set -- "$ARGS"

while true; do
  case "$1" in
    '--interactive')
      interactive=true
      shift
      continue
      ;;
    '-u'|'--until')
      until=$(date -d "$2" --utc +"%Y-%m-%d")
      shift 2
      continue
      ;;
    '--')
      shift
      break
      ;;
    *)
      exit_error 'Internal error!'
      ;;
  esac
done
action=${@:$OPTIND:1}
shift

cluster_name=${@:$OPTIND:1}
cluster_name=${cluster_name:-$USER}
shift

organization="${USER}"

echo "> name: $cluster_name"
echo "> organization: $organization"

cluster_namespace=$(kubectl get cl -Algiantswarm.io/cluster=theo01 -oyaml|yq -r '.items[0].metadata.namespace')

case "$action" in
  "status")
    clusterctl describe cluster "$cluster_name" --namespace="$cluster_namespace" --show-conditions=all
    exit
    ;;
  "keep")
    kubectl label cluster "$cluster_name" \
      --namespace="$cluster_namespace" \
      --overwrite=true \
      keep-until="$until"
    exit
    ;;
esac

echo -n "> installation: "
installation=$(get_installation $interactive)
if [[ -z "$installation" ]]; then
	echo "not found!"
	echo "> stopping"
	exit 0
fi
if echo "$installation" | grep -q '-'; then
	echo "$installation - invalid!"
	echo "> stopping"
	exit 0
fi
echo "$installation"

echo -n "> provider: "
provider=$(opsctl show installation -i "$installation" | yq -r .Provider)
echo "$provider"

echo -n "> release: "
release_arg=""
if [[ ! "$provider" =~ ^cap.+ ]]; then
  release=$(get_release $interactive)
  if [[ -z "$release" ]]; then
    echo "not found!"
    echo "> stopping"
    exit 0
  fi
  release_arg="--release $release"
fi
echo "$release"

echo -n "> availability zone: "
zone=$(kubectl get node -oyaml | yq -r '.items[0].metadata.labels["topology.kubernetes.io/zone"]')
if [[ -z "$zone" ]] || [[ "$zone" == "null" ]]; then
	echo "not found!"
	echo "> stopping"
	exit 0
fi
echo "$zone"

set -ex

case "$action" in
  "apply")
    kubectl gs template organization \
      --name "$organization" \
      | kubectl $action -f - || echo 1

    kubectl gs template cluster \
      --provider "$provider" \
      $release_arg \
      --name "$cluster_name" \
      --organization "$organization" \
      --description "$cluster_name test cluster" \
      | kubectl $action -f -

    if [[ ! "$provider" =~ ^cap.+ ]]; then
      kubectl-gs template nodepool --provider "$provider" \
        $release_arg \
        --cluster-name "$cluster_name" \
        --availability-zones "$zone" \
        --organization "$organization" \
        --description "$cluster_name nodepool" \
        | kubectl $action -f -
    fi
    ;;
  "delete")
    if [[ ! "$provider" =~ ^cap.+ ]]; then
      kubectl-gs template nodepool --provider "$provider" \
        --release "$release" \
        --cluster-name "$cluster_name" \
        --availability-zones "$zone" \
        --organization "$organization" \
        --description "$cluster_name nodepool" \
        | kubectl $action -f - || echo 1
    fi

    kubectl gs template cluster \
      --provider "$provider" \
      --release "$release" \
      --name "$cluster_name" \
      --organization "$organization" \
      --description "$cluster_name test cluster" \
      | kubectl $action -f - || echo 1

    kubectl gs template organization \
      --name "$organization" \
      | kubectl $action --wait=false -f - || echo 1
    ;;
  *)
    echo "invalid action: $action"
    exit 1
    ;;
esac

set +x

echo "> success"
